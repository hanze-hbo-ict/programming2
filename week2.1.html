<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Bart Barnard" /><link rel="canonical" href="https://bioinf.nl/~bbarnard/programming4/week2.1.html" />
      <link rel="shortcut icon" href="img/favicon.ico" />
    <title>Week 2.1: Network operations - Programming 4</title>
    <link rel="stylesheet" href="css/theme.css" />
    <link rel="stylesheet" href="css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="css/extra.css" rel="stylesheet" />
        <link href="css/ansi-colours.css" rel="stylesheet" />
        <link href="css/jupyter-cells.css" rel="stylesheet" />
        <link href="css/pandas-dataframe.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Week 2.1: Network operations";
        var mkdocs_page_input_path = "week2.1.md";
        var mkdocs_page_url = "/~bbarnard/programming4/week2.1.html";
      </script>
    
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="index.html" class="icon icon-home"> Programming 4
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="./search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="index.html">Introduction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="week1.1.html">Multiple Class Interaction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="week1.2.html">SOLID and design patterns</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="week1.4.html">List comprehensions and generators</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="week2.2.html">Parallelisation</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Programming 4</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html" class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Week 2.1: Network operations</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="week-21-network-operations">Week 2.1: Network operations<a class="headerlink" href="#week-21-network-operations" title="Permanent link">&para;</a></h1>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>In this week, we are going to serve data over the network. It is very improbable that you will do all of your calculations on your own machine, as it can take up a lot of time and resources. That is why we outsource the computation to other machines, so that we only have to wait for the results to come in.</p>
<p>As has been explained, in this scenario we need two types of techniques: client-server architecture and asynchronous programming. During the planairy part both of these have been explained and demonstrated; now it is time to integrate the whole shebang and come up with a complete system.</p>
<p><img alt="The whole shebang in a old charabanc..." src="imgs/charabanc.jpeg" /></p>
<h2 id="exercise-1-create-a-server">Exercise 1: create a server<a class="headerlink" href="#exercise-1-create-a-server" title="Permanent link">&para;</a></h2>
<p>As has been explained during the plenairy part, you can easily create a (rather rudimentary but good enough for our purposes) server using <a href="https://docs.python.org/3/library/http.server.html">Python's http server module</a>. For easy reference, the most basic setup is repeated below:</p>
<div class="highlight"><pre><span></span><code><span class="n">PORT</span> <span class="o">=</span> <span class="mi">8080</span>
<span class="n">handler</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">SimpleHTTPRequestHandler</span>
<span class="n">http</span> <span class="o">=</span> <span class="n">socketserver</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">((</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">PORT</span><span class="p">),</span> <span class="n">ServerHandler</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;serving at port&quot;</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
<span class="n">http</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</code></pre></div>
<p>The idea of this exercise it that we are going to make a server that serves the same wheather-data that we used <a href="week1.3.html">in exercise 1.3</a>. You can find the datafile <a href="files/dSST.csv">using this link</a>. The server will have only one endpoint <code>/data</code>, that you can call with either <code>/all</code>, <code>/{year}</code> or <code>/{from-year}/{to-year}</code>:</p>
<table>
<thead>
<tr>
<th>method</th>
<th>endpoint</th>
<th>status-code</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>GET</code></td>
<td><code>/data/all</code></td>
<td>200 Ok</td>
<td>Gets all the data in de file</td>
</tr>
<tr>
<td><code>GET</code></td>
<td><code>/data/{year}</code></td>
<td>200 Ok</td>
<td>Gets the wheater-data of that particula date</td>
</tr>
<tr>
<td>"</td>
<td>"</td>
<td>404 Not found</td>
<td>if there is no data for that date</td>
</tr>
<tr>
<td>"</td>
<td>"</td>
<td>400 Illegal request</td>
<td>if the <code>year</code> is not a year</td>
</tr>
<tr>
<td><code>GET</code></td>
<td><code>/data/{from-year}/{to-year}</code></td>
<td>200 Ok</td>
<td>Gives the wheather-date from <code>from-year</code> to <code>to-year</code> (inclusive)</td>
</tr>
<tr>
<td>"</td>
<td>"</td>
<td>404 Not found</td>
<td>if there is no data for this range</td>
</tr>
<tr>
<td>"</td>
<td>"</td>
<td>400 Illegal request</td>
<td>if either <code>from-year</code> or <code>to-year</code> is not a year</td>
</tr>
</tbody>
</table>
<p>If a request is done to another endpoint, the server will just respond with a 404.</p>
<h3 id="step-1-check-the-request">step 1: check the request<a class="headerlink" href="#step-1-check-the-request" title="Permanent link">&para;</a></h3>
<p>In the code above, we are using <code>Python's SimpleHTTPRequestHandler</code> to handle our requests. Make a new class that extends <code>SimpleHTTPRequestHandler</code> so that we can have control over our requests. In this new class, create the method <code>go_GET</code> that gets called whenever a GET-request is done to our URI (this is done automatically for you by <code>http.server</code>: please <a href="https://docs.python.org/3/library/http.server.html#http.server.SimpleHTTPRequestHandler.do_GET">refer to the documentation</a>). </p>
<p>In this method, check the path of the request (using <code>self.path</code>) to see whether the request in indeed to <code>/data</code>. If this is not the case, respond with a <code>404 Not found</code>, using the method <code>send_error</code> <a href="https://docs.python.org/3/library/http.server.html#http.server.BaseHTTPRequestHandler.send_error">that is provided in <code>SimpleHTTPRequestHandler</code></a>. Next, check whether the request ends with <code>/all</code> or contains one or two dates. If this is not the case, we respond with a <code>400 Bad Request</code> error.</p>
<h3 id="step-2-create-the-data-provider">step 2: create the data-provider<a class="headerlink" href="#step-2-create-the-data-provider" title="Permanent link">&para;</a></h3>
<p>In order to separate the http request-handling from the data-handling, you need to create a new class <code>DataProvider</code>, which is responsible for (you guessed it) providing the data. Give this class a method that contains a parameter on basis of which all or a piece of the wheather data is returned. So this method should give all the data back when it is called with <code>all</code> as a parameter, one line of data when this method is called with only one year for this parameter, and a list of data when it is called with a tuple of two years. Have a look at the code below to get an idea of the workings of this method.</p>
<p>If the parameter does not comply to the requirements stated above, it should raise a <code>ValueError</code>. You can use pandas for this class. For now, the method should return a json string.</p>
<div class="admonition info">
<p class="admonition-title">Transpose the json</p>
<p>When using <code>to_json</code> in pandas, the returned json is somewhat strange: it uses the index of the DataFrame as a key for every value. In order to make the json more logical, you can <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.transpose.html">transpose the DataFrame</a> before you call <code>to_json</code>.</p>
</div>
<div class="highlight"><pre><span></span><code>    <span class="n">d</span> <span class="o">=</span> <span class="n">DataProvider</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get_data</span><span class="p">())</span> <span class="c1"># returns all the data in de csv as one json-stream</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="mi">1991</span><span class="p">))</span> <span class="c1"># returns one line of data; the one that corresponds to the year 1991 (line 113)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get_data</span><span class="p">([</span><span class="mi">1991</span><span class="p">,</span><span class="mi">2000</span><span class="p">]))</span> <span class="c1"># returns 10 lines of data, from the year 1991 to 2000</span>
</code></pre></div>
<h3 id="step-3-use-the-data-provider-in-the-request-handler">step 3: use the data-provider in the request handler<a class="headerlink" href="#step-3-use-the-data-provider-in-the-request-handler" title="Permanent link">&para;</a></h3>
<p>Now, use this data-provider in the request handler so that its method is called in the correct manner. This means that you need to check the format of the request in your <code>go_GET</code> method and call the data-provider method in the appropriate corresponding manner. If the data-provider raises a <code>ValueError</code>, you need to respond with status-code 400 again.</p>
<p>Make sure your server responds with a <code>Status-Code</code> of 200 and a <code>Content-Type</code> header with value <code>application/json</code>. You can use your browser to check the results; just make sure you have the inspector tools open in order to check the headers that your server returns. Alternatively, you can use <code>curl -i</code> to achieve the same result.</p>
<p><img alt="A request to our server in FireFox" src="imgs/browser.png" /></p>
<h2 id="exercise-2-create-an-async-client">Exercise 2: create an async client<a class="headerlink" href="#exercise-2-create-an-async-client" title="Permanent link">&para;</a></h2>
<p>Now, we are going to create a client that calls the end points of the server we have defined above and consumes the results. Make at least two different functions that can operate on the data â€“ you can use <a href="week1.3.html#step-2-consuming-the-data">the same methods you have created in exercise 1.3</a>, or create another interesting metrics for this wheather data. These functions need to <em>return</em> something (like a <code>dict</code> with average temperatures, for example). </p>
<p>Create a class <code>NetworkClient</code> that receives the base-url of the server on its initialization (most likely this will be something like <code>http://localhost:8000/data/</code>). Provide this class with a method that receives an endpoint from which to fetch the data, and a function that needs to be called when the data has been received. Make sure that this function is non-blocking (in other words, make it an <code>async def</code> and provide <code>awaits</code> where necessary). Have this method return whatever the provided function returns and use that return value in some kind of visualisation (just a dump on the command line will suffice).</p>
<p>Finally, create list of several calls to this method and use <code>asyncio.gather</code> to run these calls. Have a look at the example code below to get an idea of the workings:</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">demo_delay</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;http://jsonplaceholder.typicode.com/todos/1&#39;</span><span class="p">,</span> <span class="n">print_data</span><span class="p">),</span>
        <span class="n">demo_delay</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
        <span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;http://jsonplaceholder.typicode.com/todos/2&#39;</span><span class="p">,</span> <span class="n">print_data</span><span class="p">),</span>
        <span class="n">demo_delay</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</code></pre></div>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Bart Barnard</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="js/jquery-3.6.0.min.js"></script>
    <script>var base_url = ".";</script>
    <script src="js/theme_extra.js"></script>
    <script src="js/theme.js"></script>
      <script src="js/imgs.js"></script>
      <script src="js/matjax.js"></script>
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script src="search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
