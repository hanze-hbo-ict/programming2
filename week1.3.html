<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="Bart Barnard" /><link rel="canonical" href="https://hanze-hbo-ict.github.io/programming2/week1.3.html" />
      <link rel="shortcut icon" href="img/favicon.ico" />
    <title>Week 1.3: Multiple Class Interaction - Programming 2</title>
    <link rel="stylesheet" href="css/theme.css" />
    <link rel="stylesheet" href="css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="css/extra.css" rel="stylesheet" />
        <link href="css/ansi-colours.css" rel="stylesheet" />
        <link href="css/jupyter-cells.css" rel="stylesheet" />
        <link href="css/pandas-dataframe.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Week 1.3: Multiple Class Interaction";
        var mkdocs_page_input_path = "week1.3.md";
        var mkdocs_page_url = "/programming2/week1.3.html";
      </script>
    
    <script src="js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="index.html" class="icon icon-home"> Programming 2
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="./search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="index.html">Programming 2</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="week1.1.html">Week 1.1: Static code analysis</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="week1.2.html">Week 1.2: Classes and instances</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="week1.3.html">Week 1.3: Multiple Class Interaction</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#step-1-producing-data">Step 1: Producing data</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1a-from-csv-to-json">1a: from CSV to JSON</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#1b-getting-the-data">1b. getting the data</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#step-2-consuming-the-data">Step 2: Consuming the data</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#step-3-the-observer-pattern">Step 3: The observer pattern</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#3a-extending-the-reader">3a: Extending the reader</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#3b-extending-the-consumers">3b: Extending the consumers</a>
    </li>
        </ul>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="week1.4.html">Week 1.4: Generators and Map-Reduce</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="week1.5.html">Week 1.5: Divide and Conquer Algorithms</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Programming 2</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html" class="icon icon-home" alt="Docs"></a> &raquo;</li>
      <li>Week 1.3: Multiple Class Interaction</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="week-13-multiple-class-interaction">Week 1.3: Multiple Class Interaction<a class="headerlink" href="#week-13-multiple-class-interaction" title="Permanent link">&para;</a></h1>
<p>In this exercise, we will be building a relatively complex system that consists of several classes that need to coordinate certain events. In the process, we introduce the concept of asynchronicity, generators, parallelism and message queues. The central idea is that we have some data that needs to be harvested, transformed and distributed. We build this application in several more or less independent steps, in order to bring the idea home that separation and compartmentalization are good things.</p>
<h2 id="step-1-producing-data">Step 1: Producing data<a class="headerlink" href="#step-1-producing-data" title="Permanent link">&para;</a></h2>
<p>Download <a href="files/dSST.csv">the file dSST.csv</a> and study its contents. This is a comma-separated data file consisting of the average monthly global temperature anomalies between the years 1880-2021. These temperatures are based on the GISS Surface Temperature Analysis (GISTEMP v4), an estimate of global surface temperature change. Anomalies are defined relative to a base period of 1951-1980.</p>
<h3 id="1a-from-csv-to-json">1a: from CSV to JSON<a class="headerlink" href="#1a-from-csv-to-json" title="Permanent link">&para;</a></h3>
<p>We want this data to be made available in JSON instead of CSV. The big difference between these two data formats is that the first line of a CSV-file contains all the properties (<em>keys</em>) of the data, while JSON needs to have these properties repeated. Have a look at the following example:</p>
<div class="highlight"><pre><span></span><code>key1,key2
1880,3.14
1881,2.87
</code></pre></div>
<p>which in JSON would be</p>
<div class="highlight"><pre><span></span><code><span class="p">[{</span><span class="nt">&quot;key1&quot;</span><span class="p">:</span><span class="mi">1880</span><span class="p">,</span><span class="nt">&quot;key2&quot;</span><span class="p">:</span><span class="mf">3.14</span><span class="p">},{</span><span class="nt">&quot;key1&quot;</span><span class="p">:</span><span class="mi">1881</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;key2&quot;</span><span class="p">:</span><span class="mf">2.87</span><span class="p">}]</span>
</code></pre></div>
<p>Create a class <code>CsvConverter</code> which does exactly this. Make sure that when you create an instance of this class, the <em>header</em> (first line) of a CSV-file is added. Since this is usually just a string, make sure to split this line using <code>str.split(',')</code> in order to create a list of keys. </p>
<p>Add a method <code>csv_to_json()</code> which receives a list of lines from a CSV-file and returns this data as JSON. Again, since the lines are just strings, use <code>split</code> to transform each line into a list of values. Make sure that the amount of items in each line corresponds to the number of elements in the header that you stored in the object (make use of <code>assert</code> and issue a nice warning when the numbers don't match). Use the following code as an example for your implementation:</p>
<div class="highlight"><pre><span></span><code><span class="o">&gt;&gt;&gt;</span> <span class="n">keys</span> <span class="o">=</span> <span class="s1">&#39;a,b,c,d&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">vals</span> <span class="o">=</span> <span class="s1">&#39;3,2,1,5&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">),</span> <span class="n">vals</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)))</span>
<span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="s1">&#39;5&#39;</span><span class="p">}</span>
<span class="o">&gt;&gt;&gt;</span> 
</code></pre></div>
<p>You may need to use <code>json.dumps()</code> in your method to make sure that the returned value is indeed valid JSON (past it into <a href="https://jsonparser.org/">jsonparser.org</a> when in doubt).</p>
<h3 id="1b-getting-the-data">1b. getting the data<a class="headerlink" href="#1b-getting-the-data" title="Permanent link">&para;</a></h3>
<p>Create a class <code>Reader</code> which gets the location of a CSV-file in its constructor (you might want to default this to our <code>dSSST.csv</code>). Also in the constructor, create an instance of the <code>CvsConcerter</code> and store that in the object's memory space. <code>Reader</code>-objects will read the given CSV-files in strides of a certain amount of lines. In order to do this, you will need to do some bookkeeping within the object itself: you will need to store both the number of lines that are read in one go and also a pointer to the current line in the file. </p>
<p>Add a method <code>get_lines()</code> to the <code>Reader</code>-class. In this method, the next stride of lines is returned as JSON. You can use <a href="https://docs.python.org/3/library/linecache.html"><code>linecache</code></a> to read certain lines of the data file. So, given that the first line of our CSV-file contains its keys, a flow could be like this (output omitted for readability):</p>
<div class="highlight"><pre><span></span><code><span class="n">red</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="s1">&#39;dSST.csv&#39;</span><span class="p">)</span>
<span class="n">red</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()</span> <span class="c1">#returns lines 2-6 as json</span>
<span class="n">reg</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()</span> <span class="c1">#returns lines 7-11 as json</span>
<span class="n">reg</span><span class="o">.</span><span class="n">get_lines</span><span class="p">()</span> <span class="c1">#returns lines 12-16 as json</span>
</code></pre></div>
<p>If there are no more lines in the data file, the method <code>get_lines()</code> needs to return an empty string.</p>
<h2 id="step-2-consuming-the-data">Step 2: Consuming the data<a class="headerlink" href="#step-2-consuming-the-data" title="Permanent link">&para;</a></h2>
<p>We are going to create two classes, <code>AverageYear</code> and <code>AverageMonth</code> that make use of this temperature data that is being provided by objects of the <code>Reader</code>-class. There are, of course, several ways in which you can make these <code>Reader</code>-objects available in the consuming classes: we can create a new <code>Reader</code>-object when initializing our consumer, or we can make one <code>Reader</code>-object and give that object to the initializer of the consumers. What do you think are the pros and cons of both approaches?</p>
<p>The first consuming class will show the <em>average temperature anomaly</em> for the complete set of five years that our <code>Reader</code> is returning. the second class needs to show the <em>average monthly anomaly</em> for the same five years. Please note that the number of columns is <em>larger</em> than the number of months within the year (the last few columns are some kind of special meteorological averages), so be sure to take the right data. Of course, in both classes you can make use of pandas, numpy, matplotlib and all kind of libraries you are used to in order to make some sort of visualisation.</p>
<p>Within both classes, use consecutive calls to <code>get_lines()</code> in order to get the next stride of lines from this data-class. Stop calling this method whenever this method returns an empty string. You don't <em>need</em> to make an incremental plot with each new call to <code>get_lines()</code> (thought that would be a nice addition): it is sufficient when you repaint your visualisation every time new data gets returned.</p>
<p>In the end, the architecture would look as follows:</p>
<p><img alt="Architecture after exercise 2" src="imgs/class-diagram.png" /></p>
<p>There are several issues with this architecture, regardless of the way in which you provided the consuming classes with the <code>Reader</code>-objects. In the following step, we are going to decouple these classes in order to create a more robust and versatile system.</p>
<h2 id="step-3-the-observer-pattern">Step 3: The observer pattern<a class="headerlink" href="#step-3-the-observer-pattern" title="Permanent link">&para;</a></h2>
<p>During the theoretical part, the observer pattern was briefly described. For easy reference, the sequence diagram that was shown is repeated here:</p>
<p><img alt="Observer pattern sequence diagram" src="imgs/observer.png" /></p>
<p>In this step, we are going to refactor the classes you've created in step 3 in order to realise this design pattern.</p>
<h3 id="3a-extending-the-reader">3a: Extending the reader<a class="headerlink" href="#3a-extending-the-reader" title="Permanent link">&para;</a></h3>
<p>Create two methods in the <code>Reader</code>-class, <code>add_observer()</code> and <code>remove_observer()</code> so that we can add and remove observers. Make sure that when we create a new instance of the <code>Reader</code>, you create an empty <em>set</em> within the memory-space of the <code>Reader</code>. A call to the first method should add the given observer to this list, a call to the second call will (drumm-roll) <em>remove</em> the observer from the list if it is present. If the observer is not present in the list, make sure that nothing happens (removing a non-existent observer from this list is not a reason the crash a system)</p>
<p>Next, add a method to <code>notify_observers()</code> to <code>Reader</code>. When called, this method needs to iterate over all the registered observers and call <code>update()</code> on each of them. Now, change the <code>Reader</code> so that the next five lines (the <em>stride</em>) are produced every five seconds (you can make use of <code>time.sleep(5)</code> in order to accomplish this) and every time new data is read a call to <code>notify_observers()</code> is made.</p>
<h3 id="3b-extending-the-consumers">3b: Extending the consumers<a class="headerlink" href="#3b-extending-the-consumers" title="Permanent link">&para;</a></h3>
<p>Now we need to change the two consumers we created in step 2. Instead of making them responsible for the call to <code>next_lines()</code>, we just let them react to the updates of the <code>Reader</code>-class. Whenever this class has new data available, it will run <code>notify_observers()</code> which in turn will call <code>update()</code> on the observer.  Make sure that whenever the <code>update</code>-method is called from the producer, the same visualisation that you made in step 2 is rendered. Please refer to the listing below to get an idea of the infrastructure that is required:</p>
<div class="highlight"><pre><span></span><code><span class="n">prod</span> <span class="o">=</span> <span class="n">Reader</span><span class="p">(</span><span class="s1">&#39;dSST.csv&#39;</span><span class="p">)</span>
<span class="n">cons1</span> <span class="o">=</span> <span class="n">AverageYear</span><span class="p">()</span>
<span class="n">cons2</span> <span class="o">=</span> <span class="n">AverageMonth</span><span class="p">()</span>
<span class="n">prod</span><span class="o">.</span><span class="n">register_observer</span><span class="p">(</span><span class="n">cons1</span><span class="p">)</span>
<span class="n">prod</span><span class="o">.</span><span class="n">register_observer</span><span class="p">(</span><span class="n">cons2</span><span class="p">)</span>
</code></pre></div>
<p>If all goes well, some of the problems we encountered earlier are more or less solved. However, this architecture has some problems of its own. Can you see where this goes wrong and how you can solve them?</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="week1.2.html" class="btn btn-neutral float-left" title="Week 1.2: Classes and instances"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="week1.4.html" class="btn btn-neutral float-right" title="Week 1.4: Generators and Map-Reduce">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Bart Barnard</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="week1.2.html" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="week1.4.html" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '.';</script>
    <script src="js/theme_extra.js" defer></script>
    <script src="js/theme.js" defer></script>
      <script src="js/imgs.js" defer></script>
      <script src="js/matjax.js" defer></script>
      <script src="https://polyfill.io/v3/polyfill.min.js?features=es6" defer></script>
      <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>
      <script src="search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
